---
layout: post
comments: true
title:  "Пост о том, как восстанавливать данные (и как в такую ситуацию не попадать)"
excerpt: "Навеяно сегодняшним криком о помощи и тем, сколько лишних и вредных действий сделал как сам автор, так и все советующие 'запусти программу Х, она всё вытащит' на диске, который показывает очевидные признаки загибания.

Итак, как же лучше всего действовать, если диск с очень ценными и важными данными неожиданно стал умирать? 

0. Иметь бэкап и не попадать в такую ситуацию.

0.1 Не суетиться и не паниковать. "
---

# Пост о том, как восстанавливать данные (и как в такую ситуацию не попадать):
Навеяно сегодняшним криком о помощи и тем, сколько лишних и вредных действий сделал как сам автор, так и все советующие "запусти программу Х, она всё вытащит" на диске, который показывает очевидные признаки загибания.

Итак, как же лучше всего действовать, если диск с очень ценными и важными данными неожиданно стал умирать? 

0. [Иметь бэкап и не попадать в такую ситуацию](#как-не-попадать-в-ситуацию-когда-тебе-нужно-срочно-восстанавливать-данные-из-умирающего-диска)

1. Не суетиться и не паниковать. Данные не гниют, даже когда диск наполовину мертвый спокойно лежит на полке и чаще всего нет ничего такого, что нужно прямо вот срочно (если есть, то разумнее сразу идти в специальный рекавери сервис, там и быстрее и надёжнее). Лучше всего не поддаваться горячке, начинать качать и запускать все программы подряд, делать "проверку диска", "восстановление бэдблоков" и прочие быстрые форматирования и восстановления разделов. Лучше всего действовать максимально консервативно и систематически: если есть сомнения выбирать более безопасный и неразрушительный вариант. Готовьтесь, что всё займет кучу времени, особенно для гигантских современных дисков. 

1. Отключить диск и оценить ситуацию. Важно понять есть ли с самим диском физические проблемы. Если всё выглядит просто случайным повреждением каких-нибудь файловых структур после пропадания питания или ещё чего-то подобного -- можно попробовать скопировать самые важные данные на живой диск, а с остальным дальше разобраться отдельно -- копировать остальное (снять образ), форматировать, разбивать на разделы и т.д. Если же диск ведёт себя так или иначе странно: есть посторонние шумы, затыкания при обращении к диску, пропадание каких-нибудь папок или что угодно не обычное -- подозревайте худшее и действуйте максимально быстро (с точки зрения времени во включенном состоянии).

2. Лучше всего на этом этапе отнести нормальным пацанам, но если есть желание рискнуть самому, то следующим этапом нужно пойти и купить пару жестких дисков, да побольше, чтобы как-минимум был гарантированно больше помирающего. И флешку, линукс записать.

3. Загрузиться в линукс и запустить ddrescue (без подчеркивания, вот тут детали о разнице: https://askubuntu.com/questions/211578/whats-the-difference-between-ddrescue-gddrescue-and-dd-rescue). Три раза проверить откуда и куда собираешься копировать (проще всего копировать прямо на новый девайс). В несильно запущенном случае, эта штука скопирует всё на диске, пропустит битые сектора, попробует сначала и с конца и т.д. Если диск ещё откливается и не зависает намертво при обращении к проблемным местам -- то это позволит скопировать подавляющее большинство данных. Дальше можно отключать пациента, класть аккуратно на полочку, подключать копию к компьютеру и смело играть с какими угодно программами восстановления (сохраняя результаты на второй новый диск конечно же)

4. После удовлетворения восстановленными данными (не забыв три раза подумать и поискать во всяких необычных местах), можно вернуться к пациенту и добить (попробовать запустить или убедиться что не работает и т.д.). 

5. Если пункт 3 не работает -- то к специалистам. 

Если показалось слишком сложно -- то скорее всего не такие уж там и важные данные были.

## Как не попадать в ситуацию, когда тебе нужно срочно восстанавливать данные из умирающего диска

Для начала, нужно понять, что диски смертны и при этом внезапно смертны и это всегда происходит в неподходящий момент (подходящих моментов конечно же никогда не бывает для такого дела). Поэтому любые данные, у которых нет копии где-то, я лично считаю  "не закомичеными" (и, например, скопировав с флешки фотоаппарата фотографии, не удаляю их оттуда до тех пор, пока бэкап не пройдет, потому что кто знает, может я прямо сейчас нечаяно смахну ноутбук со стола и диск превратится в кашу). Кроме простой поломки может случиться ещё куча всего -- начиная от кражи (~50 тысяч в год и твой ноутбук обязательно унесут), продолжая пожарами (~100 тысяч в год) и заканчивая прорывами отопления, затоплением соседями, землетрясением  и просто 380вольт в розетке, после которых от электроники остаются одни угольки. 

Поэтому будет очень обидно, если тщательно охранемые и копируемые данные (на соседний раздел или даже второй диск или даже отдельный девайс типа наса) будут преотлично уничтожены тем же, что убило основную копию. Отсюда простой вывод: хороший бэкап -- оффсайт бэкап. Как минимум делать регулярно (зашифрованную) копию всего самого важного на внешний винт и уносить хотя бы родителям или там в банковскую ячейку. 

Но ручной метод -- это геморой, а геморой ведёт к тому, что делаться это не будет. Слава богу, мы в 21 веке и автоматизацию уже изобрели и ещё облака и вот это всё. Поэтому нужно как минимум хранить самое важное в каком-нибудь дропбоксе или уандрайве. Ещё есть такая штука как backblaze, 95$ за полный безлимит на два года, бэкапит полностью содержимое компа, включая всякие подключенные сетевые диски (любители свободного линукса могут наколбасит себе сами что-то подобное с джобами в кроне, rclone и провайдером на выбор) -- если это звучит как слишком дорого или сложно, значит "ценные" данные вообще не стоят заботы и так далеко читать тоже не было смысла. 

Мое мнение, что разумный минимум -- это офлайн-копия на внешний жесткий диск (time machine или file history) и онлайн-копия в каком-нибудь облаке. Более параноидальный вариант: ещё один офлайн, офсайт бэкап на отдельный диск с наиболее ценными данными (не знаю, мастер-ключ от менеджера паролей или криптокошельки какие-нибудь) и _пара_ облачных копий, потому что облака тоже смертны, сервисы не вечны, учетные записи блокируют (да, такое бывает и чаще чем кажется и без объяснения причин и без особой возможности подать аппеляцию) и целые регионы попадают под санкции (или страны вводят ограничения сами), теряя доступ. 

Другой вопрос зачем так заморачиваться, когда "фотки на мобильнике, проекты на гитхабе, датасеты скачать", но тут каждый делает выбор для себи и если кто-то решил сохранить что-то для себя и надежно, то эта небольшая заметка расскажет как именно это сделать. Некоторые и собственный адрес почты запомнить не могут, даже если записывают, потому что потом не помнят какая из записей на секретном листочке актуальная и счастливо живут.

И да, не забывайте периодически проверять как вся эта ваша система работает, хотя бы раз квартал-другой сделать вид "а что если у меня сейчас бы всё наебнулось, как бы я данные достал" и посмотреть что же на самом деле у вас сохранено, а что нет и почему. А то будет неожиданный позор, как у этих ребят: https://about.gitlab.com/2017/02/10/postmortem-of-database-outage-of-january-31/

Пишите смело как я не прав и на самом деле надо смело кидать диск в морозильник, потом с помощью изи рекавери с одного раздела на другой восстановить файлы, а все эти резервные копии для слабаков и уж тем более не существует людей в здравом уме, кто делает несколько копий и беспокоится о том, что его могут от гуглдрайва отключить.
